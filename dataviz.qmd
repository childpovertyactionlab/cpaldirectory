---
title: "Data Visualization"
title-block-banner: TRUE
fig-width: 7
#fig-height: 5
warning: FALSE
error: TRUE
echo: FALSE
message: FALSE
code-fold: TRUE
code-summary: "Reveal Code"
code-copy: hover
---

```{r, Load Data}
#| include: FALSE
library(cpaltemplates)
library(tidycensus)
library(tidyverse)
library(rio)
library(sf)

counties <- tigris::counties(state = "TX")

years <- lst(2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021)

acs_var <- c(
  tot_pop = "S1701_C01_001", #total population
  pop_u18 = "S1701_C01_002", #population under 18
  pop_bp = "S1701_C02_001", #population below poverty
  bp_u18 = "S1701_C02_002", #population under 18 below poverty
  mhi = "B19013_001", #median household income
  thh = "B25003_001", #total housing units
  rohh = "B25003_003", #renter occupied households
  oohh = "B25003_002" #owner occupied households
)

##### Pull Data from 2012 to 2021 #####
cpal_multi <- map(
  years,
  ~get_acs(
    geography = "place", 
    variables = acs_var,
    year = .x, 
    survey = "acs5", 
    output = "wide"),
  ) %>%
  map2(years, ~mutate(.x, year = .y)) %>%
  reduce(., rbind) %>%
  mutate(cbp = round(bp_u18E/pop_u18E, digits = 4),
         bp = round(pop_bpE/tot_popE, digits = 4),
         NAME = str_replace(NAME, " city", ""))

cpal_dallas <- get_acs(
    geography = "tract", 
    state = "TX",
    county = "Dallas County",
    variables = acs_var,
    year = 2021, 
    survey = "acs5", 
    output = "wide") %>%
  mutate(cbp = round(bp_u18E/pop_u18E, digits = 4),
         bp = round(pop_bpE/tot_popE, digits = 4))

##### Join into Complete Dataset #####
cpal_comp <- cpal_multi %>%
  group_by(NAME) %>%
  arrange(NAME, year) %>%
  mutate(cbp_diff = cbp-lag(cbp, n=1),
         cbp_ave = (cbp+lag(cbp, n=1)+lag(cbp, n=2))/3,
         cbp_avedif = cbp_ave-lag(cbp_ave, n=1)
         ) %>%
  ungroup() %>%
  mutate(highlight=ifelse(NAME == "Dallas, Texas", "DAL", "NONE"),
         year = as.Date(paste0(year, "-01-01")))

##### Filter out multiple groups based on population size #####
cpal_1mil <- cpal_comp %>%
  group_by(NAME) %>%
  filter(any(tot_popE >= 1000000)) %>%
  mutate(CODE = ifelse(NAME == "Chicago, Illinois", "CHI", 
                       ifelse(NAME == "Dallas, Texas", "DAL", 
                              ifelse(NAME == "Houston, Texas", "HOU", 
                                     ifelse(NAME == "Los Angeles, California", "LA", 
                                            ifelse(NAME == "New York, New York", "NYC", 
                                                   ifelse(NAME == "Philadelphia, Pennsylvania", "PHI", 
                                                          ifelse(NAME == "Phoenix, Arizona", "PHO", 
                                                                 ifelse(NAME == "San Antonio, Texas", "SATX", 
                                                                        ifelse(NAME == "San Diego, California", "SD", 
                                                                               ifelse(NAME == "San Jose, California", "SJ", "ERROR")))))))))))

cpal_texas <- cpal_comp %>%
  filter(str_detect(NAME, ", Texas")) %>%
  group_by(NAME) %>%
  filter(any(tot_popE >= 500000)) %>%
  mutate(CITY = str_remove(NAME, ", Texas"))

```

# Background
If you have any questions, please contact Michael Lopez (michael@childpovertyactionlab.org).

## Graphic Design Principles

When creating graphics to share with stakeholders, it is important to consider key graphic design principles. These principles help ensure that the visuals effectively communicate information while maintaining clarity and transparency:

**Simplicity:** Keep the design clean, uncluttered, and visually straightforward. Use minimalistic and intuitive elements that allow stakeholders to focus on the data without distractions.

**Consistency:** Maintain a consistent visual style throughout your graphics, including colors, fonts, and icons. Consistency helps stakeholders easily understand and interpret the information presented.

**Visual Hierarchy:** Arrange elements based on their importance and relevance. Use visual cues such as size, color, and position to guide stakeholders' attention and emphasize key data points.

**Clear Typography:** Choose legible fonts and font sizes that ensure readability. Use typography strategically to highlight key findings or data points while maintaining overall coherence.

**Color Palette:** Employ a cohesive color scheme that is visually appealing and enhances data comprehension. Ensure that color choices align with the intended message and accurately represent the underlying data.

**Data Visualization:** Select appropriate chart types, such as bar graphs, pie charts, or line graphs, based on the nature of the data. Use effective data visualization techniques to present complex information in a clear and accessible manner.

**Labeling and Annotation:** Provide clear labels, titles, and annotations to help stakeholders understand the context and meaning of the data. Avoid ambiguity and provide necessary explanations to maintain transparency.

**Data Accuracy and Transparency:** Ensure that the data used in the graphics is accurate, up-to-date, and transparently sourced. Clearly cite the data origins and provide contextual information to promote trust and credibility.

By incorporating these graphic design principles, you can create visually appealing graphics that effectively communicate data to stakeholders while upholding transparency and facilitating easy comprehension and interpretation of the information presented.

## Tips and Tricks

# Scatter Plots

## One-Color Scatter PLot
Scatter plots are useful for visualizing the relationship between two variables, identifying patterns or trends, and detecting outliers or anomalies.
```{r, One Color Scatter Plot}
#| echo: TRUE
#| fig-cap: A basic scatterplot visualizing a relationship between Child Poverty Rate and Median Household Income in cities with over a million population.
ggplot(cpal_1mil, aes(x=cbp, y=mhiE)) + 
  geom_point(size=2, color = "#008097") +
  theme_cpal() +
  labs(title = "MHI vs Child Poverty Rate",
       subtitle = "Cities Over 1,000,000 Population",
       x = "Child Poverty Rate",
       y = "Median Household Income") +
  scale_y_continuous(labels = scales::dollar_format(), limits = c(0, NA)) + # <1> Format scale to $ amounts and start at 0.
  scale_x_continuous(labels = scales::percent_format()) # <2> Format scale into percentage.
```

```{r, High Density Scatter Plot}
#| echo: TRUE
#| fig-cap: A high density scatterplot visualizing a relationship between Child Poverty Rate and Median Household Income in cities with over a million population.
ggplot(cpal_comp, aes(x=cbp, y=mhiE)) + 
  geom_point(size=1, alpha = 0.05, color = "#008097") + #<1> alpha changes the transparency of points plotted.
  theme_cpal() +
  labs(title = "MHI vs Child Poverty Rate",
       subtitle = "Cities in the United States",
       x = "Child Poverty Rate",
       y = "Median Household Income") +
  scale_y_continuous(labels = scales::dollar_format(), limits = c(0, NA)) +
  scale_x_continuous(labels = scales::percent_format())
```

## Varying Point Size Scatter Plot
```{r, Varying Point Size Scatter Plot}
#| echo: TRUE
#| fig-cap: A size adjusted scatterplot visualizing a relationship between Child Poverty Rate and Median Household Income in cities with over a million population with points adjusted based on total number of children below poverty.

BAMMtools::getJenksBreaks(cpal_1mil$bp_u18E, k = 4)

cpal_1mil%>%
  ggplot(aes(x=cbp, y=mhiE)) + 
  geom_point(aes(size = pop_u18E), alpha = 0.3, color = "#008097") + # <1> size aesthetic can be mapped to a variable in dataframe, but scale_radius will need to be defined
  scale_radius(range = c(3, 15), 
               breaks = c(200000, 430000, 870000, 1800000),
               labels = scales::comma) +
  theme_cpal() +
  labs(title = "MHI vs Child Poverty Rate",
       subtitle = "Cities in the United States",
       x = "Child Poverty Rate",
       y = "Median Household Income") +
  scale_y_continuous(labels = scales::dollar_format(), limits = c(0, NA)) +
  scale_x_continuous(labels = scales::percent_format())
```

# Line Graph

## Basic Line Graph
```{r, Line Graph}
#| echo: TRUE
#| fig-cap: A basic line graph visualizing a the Child Poverty Rate in the City of Dallas
unique(cpal_1mil$CODE)

cpal_1mil %>%
  filter(highlight == "DAL") %>%
  ggplot(aes(x=year, y=cbp, group = CODE, color = CODE)) + 
  geom_line(size = 2) +
  geom_point(size=3) +
  theme_cpal() +
  labs(title = "Child Poverty Rate in the City of Dallas",
       subtitle = "Between 2010 to 2021",
       x = "Year",
       y = "Child Poverty Rate") +
  scale_color_cpal(theme = "factor") +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, NA)) +
  scale_x_date(date_breaks = "3 years", date_labels = "%Y")
```

## Multiples Line Graph
```{r, Multiple Line Graph}
#| echo: TRUE
#| fig-cap: A multiples line graph visualizing the child poverty rate of multiple cities since 2010.
cpal_1mil %>%
    filter(CODE %in% c("DAL", "HOU", "SATX")) %>%
  ggplot(aes(x=year, y=cbp, group = CODE, color = CODE)) + 
  geom_line(size = 2) +
  geom_point(size=3) +
  theme_cpal() +
  labs(title = "Child Poverty Rate in Texas Cities",
       subtitle = "Between 2010 to 2021",
       x = "Year",
       y = "Child Poverty Rate") +
  scale_color_cpal(theme = "factor") +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, NA)) +
  scale_x_date(date_breaks = "1 years", date_labels = "%Y")
```

## Bar Graph
```{r, Bar Graph}
#| echo: TRUE
#| fig-cap: A basic line graph visualizing a the Child Poverty Rate in the City of Dallas
# A basic line graph visualizing a the Child Poverty Rate in the City of Dallas
cpal_1mil %>%
  filter(year == as.Date("2021-01-01")) %>%
  ggplot(aes(x=cbp, y=CODE)) + 
  geom_bar(stat = "identity", size = 2, fill = "#008097", color = "#E7ECEE") +
  theme_cpal() +
  labs(title = "Child Poverty Rate in the City of Dallas",
       x = "Year",
       y = "Child Poverty Rate") +
  scale_color_cpal(theme = "factor") +
  scale_x_continuous(labels = scales::percent_format(), limits = c(0, NA))
```

## Histogram
```{r, Histogram}
#| echo: TRUE
#| fig-cap: A basic histogram visualizing 
# A basic line graph visualizing a the Child Poverty Rate in the City of Dallas
cpal_dallas %>%
  ggplot(aes(x = pop_u18E)) + 
  geom_histogram(colour="#E7ECEE", fill="#008097") +
  geom_vline(aes(xintercept = mean(pop_u18E)), color="#E98816", linetype="dashed", size=1) +
  theme_cpal() +
  labs(title = "Histogram of Children Below Poverty in City of Dallas",
       x = "Year",
       y = "Child Poverty Rate")
```

# Interactive Graphics

## leaflet Map
```{r, Leaflet}
#| echo: TRUE
# A basic leaflet map

#counties <- tigris::counties(state = "TX")

library(leaflet)

dallas <- filter(counties, NAME == "Dallas")

bbox <- dallas %>%
      st_bbox(.) %>%
      as.vector()

leaflet(dallas) %>%
  fitBounds(bbox[1], bbox[2], bbox[3], bbox[4]) %>%
  addTiles(urlTemplate = cpal_mapbox, attribution = cpal_leaflet) %>%
  addPolygons(weight = 1,     
              opacity = 0.5,
              color = "#686158",
              fillOpacity = 0.1)

```

## Facet Graph

## Map

## plotly
